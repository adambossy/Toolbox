#!/bin/bash

set -euo pipefail

# Git clean rebase function
# Usage: git_clean_rebase
git_clean_rebase() {
    # Get current branch name
    local current_branch=$(git branch --show-current)
    
    if [ -z "$current_branch" ]; then
        echo "Error: Not in a git repository or no branch checked out"
        return 1
    fi
    
    # Detect primary branch (master or main)
    local primary_branch=""
    if git show-ref --verify --quiet refs/remotes/origin/main; then
        primary_branch="main"
    elif git show-ref --verify --quiet refs/remotes/origin/master; then
        primary_branch="master"
    else
        echo "Error: Could not find origin/main or origin/master branch"
        return 1
    fi
    
    echo "Starting git clean rebase for current branch: $current_branch"
    echo "Using primary branch: $primary_branch"
    
    # Fetch latest changes from origin
    echo "1. Fetching origin..."
    git fetch origin
    
    # Rebase on the detected primary branch
    echo "2. Rebasing on origin/$primary_branch..."
    echo "   (You may need to resolve conflicts and run 'git rebase --continue' as needed)"
    git rebase "origin/$primary_branch"
}

git_clean_rebase
